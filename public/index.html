<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="theme-color" content="#5468ff">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <style>
        :root {
            /* Main theme colors */
            --primary-color: #55b0ff;
            --primary-light: #e9ebff;
            --primary-dark: #3a4db4;
            --secondary-color: #38b2ac;
            --background-color: #f8fafc;
            --card-color: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            
            /* Message colors - simplified for contrast-based design */
            --customer-color: #ffffff;
            --claude-color: #f0f7f4;
            --receiver-color: #e9ebff;
            --system-color: #f3f4f6;
            
            /* Status colors */
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --summary-color: #fef3c7;
            --summary-border: #eab308;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            padding: 1rem;
            background-color: #b69a6ea6;
            color: var(--text-primary);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }
        
        .wrapper {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            flex: 1;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.7rem 1.25rem;
            background-color: var(--card-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: sticky;
            top: 0.5rem;
            z-index: 50;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header h1:before {
            content: '\f1e0'; /* Font Awesome chat icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        .header-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            transition: all 0.2s ease;
            position: relative;
        }
        
        /* Ensure the icon is clickable */
        .header-btn i {
            cursor: pointer;
            /* Makes sure the entire area is clickable */
            display: block;
            pointer-events: auto;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .summary-btn {
            color: var(--primary-color);
        }
        
        .header-btn:hover {
            background-color: var(--primary-light);
        }
        
        .settings-btn {
            color: var(--primary-color);
        }
        
        .info-btn {
            color: var(--primary-color);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(84, 104, 255, 0.3);
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(84, 104, 255, 0.5);
        }

        .message {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            max-width: 85%;
            position: relative;
            animation: fadeIn 0.3s ease;
            line-height: 1.5;
            font-size: 0.95rem;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message .sender {
            font-weight: 600;
            margin-bottom: 0.35rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        
        .message .content {
            word-break: break-word;
        }
        
        .message::before {
            content: '';
            position: absolute;
            height: 12px;
            width: 12px;
            bottom: -5px;
        }

        .customer-message {
            align-self: flex-end;
            background-color: #ffaea1a1;
            margin-left: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .customer-message .sender::before {
            content: '\f007';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .claude-message {
            align-self: center;
            background-color: rgba(240, 247, 244, 0.6);
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .claude-message .sender::before {
            content: '\f1e0';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        
        .summary-message {
            align-self: center;
            background-color: var(--summary-color);
            border-left: 3px solid var(--summary-border);
            margin-left: auto;
            margin-right: auto;
            width: 90%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .summary-message .sender::before {
            content: '\f15c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .receiver-message {
            align-self: flex-start;
            background-color: #cb9e3536;
            margin-right: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .receiver-message .sender::before {
            content: '\f0f2';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        
        .system-message {
            align-self: center;
            background-color: var(--system-color);
            width: 85%;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            opacity: 0.8;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .system-message .sender::before {
            content: '\f05a';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .input-container {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background-color: var(--card-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
        }

        .input-field {
            flex: 1;
            padding: 0.85rem 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 0.95rem;
            resize: none;
            transition: all 0.2s ease;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(84, 104, 255, 0.2);
        }

        .send-btn {
            padding: 0.75rem 1.25rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 90px;
            height: 45px;
        }
        
        .send-btn:before {
            content: '\f1d8';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .send-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .send-btn:active {
            transform: translateY(1px);
        }

        .send-btn:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }
        
        .voice-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .voice-btn:hover {
            background-color: #047857;
            transform: translateY(-1px);
        }
        
        .voice-btn:active {
            transform: translateY(1px);
            background-color: var(--error-color);
        }
        
        .voice-btn:active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0.6; transform: translate(-50%, -50%) scale(0.8); }
        }

        .settings-panel {
            display: none;
            position: absolute;
            top: 5.5rem;
            right: 1rem;
            background-color: var(--card-color);
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 100;
            width: 320px;
            border-top: 3px solid var(--primary-color);
            animation: slideDown 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .settings-panel.active {
            display: block;
        }

        .settings-group {
            margin-bottom: 1.25rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .settings-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-group h3 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-group h3:before {
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .settings-group:nth-child(1) h3:before { content: '\f129'; }
        .settings-group:nth-child(2) h3:before { content: '\f030'; }
        .settings-group:nth-child(3) h3:before { content: '\f007'; }
        .settings-group:nth-child(4) h3:before { content: '\f1ab'; }
        .settings-group:nth-child(5) h3:before { content: '\f0ac'; }
        .settings-group:nth-child(6) h3:before { content: '\f013'; }
        .settings-group:nth-child(7) h3:before { content: '\f1c0'; }

        .settings-group input, .settings-group select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background-color: var(--card-color);
        }
        
        .settings-group input:focus, .settings-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(84, 104, 255, 0.2);
        }
        
        /* Custom checkbox styling */
        .toggle-container {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
            margin-right: 0.75rem;
        }
        
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Responsive adjustments */
        @media (max-width: 920px) {
            .wrapper {
                max-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 0.75rem;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .header-btn {
                width: 35px;
                height: 35px;
            }

            .message {
                max-width: 90%;
                padding: 0.75rem 0.85rem;
            }
            
            .input-container {
                padding: 0.85rem 1rem;
            }
            
            .input-field {
                padding: 0.7rem 0.8rem;
            }
            
            .send-btn {
                padding: 0.7rem 1rem;
                min-width: 80px;
            }

            .settings-panel, .info-panel {
                width: 90%;
                left: 5%;
                right: 5%;
                max-height: 75vh;
            }
        }
        
        /* Dark mode support through prefers-color-scheme */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #121826;
                --card-color: #1e293b;
                --text-primary: #e2e8f0;
                --text-secondary: #94a3b8;
                
                /* Message colors - simplified for contrast-based design */
                --customer-color: #1a2234;
                --claude-color: #1c2a3a;
                --receiver-color: #1e3255;
                --system-color: #1f2937;
            }
            
            .input-field, .settings-group input, .settings-group select {
                background-color: #0f172a;
                border-color: #334155;
                color: var(--text-primary);
            }
            
            .toggle-slider {
                background-color: #334155;
            }
            
            .chat-container::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
            }
            
            .chat-container::-webkit-scrollbar-thumb {
                background: rgba(84, 104, 255, 0.5);
            }
        }

        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            font-style: italic;
            color: var(--text-secondary);
            position: relative;
            margin: 0 auto 1rem auto;
            width: fit-content;
            border-radius: 12px;
            background-color: var(--system-color);
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .typing-indicator.active {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .typing-indicator:before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            animation: blink 1.5s infinite ease-in-out;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        /* Make it obvious which mode we're in */
        .mode-indicator {
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: all 0.3s ease;
        }
        
        .customer-badge {
            background-color: var(--customer-color);
            border: 1px solid var(--customer-border);
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 15px;
            text-transform: none;
        }
        
        .customer-badge i {
            color: var(--primary-color);
        }
        
        .mode-indicator:before {
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.8rem;
            display: none;
        }

        .customer-mode .mode-indicator {
            background-color: var(--customer-color);
            border: 1px solid var(--customer-border);
            color: var(--primary-dark);
        }
        
        .customer-mode .mode-indicator:before {
            content: '\f007'; /* User icon */
        }

        .receiver-mode .mode-indicator {
            background-color: var(--receiver-color);
            border: 1px solid var(--receiver-border);
            color: var(--receiver-border);
        }
        
        .receiver-mode .mode-indicator:before {
            content: '\f0f2'; /* Briefcase icon */
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.4s ease;
        }
        
        /* Card styling */
        .panel {
            background-color: var(--card-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.25rem;
            animation: fadeIn 0.3s ease;
        }
        
        .btn {
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            cursor: pointer;
            padding: 0.75rem 1.25rem;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #94a3b8;
            transform: none;
        }
    </style>
</head>
<body class="receiver-mode">
    <div class="wrapper">
        <div class="header">
            <div>
                <img src="GGG_Wegweiser.png" alt="GGG Wegweiser Logo" id="logoImage" style="height: 4.5rem; width: auto; margin: 0px 30px;">
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span class="mode-indicator" id="modeIndicator"></span>
                <button class="header-btn share-btn" id="shareBtn" title="Share conversation link">
                    <i class="fas fa-share-alt"></i>
                </button>
                <button class="header-btn summary-btn" id="summaryBtn" title="Generate conversation summary">
                    <i class="fas fa-clipboard-list"></i>
                </button>
                <button class="header-btn settings-btn" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="header-btn info-btn" id="infoBtn">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>

        <div class="info-panel panel" id="infoPanel" style="display: none; position: absolute; top: 5.5rem; right: 1rem; z-index: 100; width: 320px; max-height: 80vh; overflow-y: auto; border-top: 3px solid var(--secondary-color); animation: slideDown 0.3s ease;">
            <h3 style="margin-bottom: 1rem; color: var(--secondary-color); font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-info-circle"></i> About Translator
            </h3>
            
            <div style="margin-bottom: 1rem; background-color: var(--primary-light); border-radius: 8px; padding: 0.75rem; border-left: 3px solid var(--primary-color);">
                <p style="margin-bottom: 0.75rem; font-size: 0.9rem; line-height: 1.5; color: var(--text-primary);">
                    This application helps bridge language barriers by providing real-time translation between different languages.
                </p>
            </div>
            
            <p style="margin-bottom: 0.75rem; font-size: 0.9rem; line-height: 1.5; color: var(--text-primary);">
                <i class="fas fa-server" style="color: var(--secondary-color); margin-right: 0.5rem;"></i>
                <strong>Technical Details:</strong> Uses a Node.js backend proxy to communicate with the Claude API.
            </p>
            
            <p style="margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">
                <i class="fas fa-cogs" style="color: var(--secondary-color); margin-right: 0.5rem;"></i>
                How it works:
            </p>
            
            <ol style="margin-left: 1.75rem; margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.6;">
                <li>The frontend sends requests to our local server</li>
                <li>The server forwards these requests to the Claude API</li>
                <li>Claude's responses are returned to the frontend</li>
            </ol>
            
            <div style="padding: 0.75rem; background-color: rgba(255, 247, 230, 0.5); border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid var(--warning-color);">
                <p style="font-size: 0.9rem; color: var(--text-primary); display: flex; align-items: center;">
                    <i class="fas fa-key" style="color: var(--warning-color); margin-right: 0.5rem;"></i>
                    To use this application, you'll need to enter your Claude API key in the settings panel.
                </p>
            </div>
            
            <button id="closeInfoBtn" class="btn btn-primary" style="width: 100%;">Close <i class="fas fa-times"></i></button>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- Messages will be added here -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            Someone is typing...
        </div>

        <div class="input-container">
            <textarea class="input-field" id="messageInput" placeholder="Type a message..." rows="2"></textarea>
            <button class="voice-btn" id="voiceBtn">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
    </div>

    <!-- Share URL Modal -->
    <div class="panel" id="shareModal" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 200; width: 90%; max-width: 400px; text-align: center;">
        <h3 style="margin-bottom: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <i class="fas fa-share-alt" style="color: var(--primary-color);"></i> Share Conversation
        </h3>
        
        <!-- QR Code Section -->
        <div style="margin-bottom: 1.5rem;">
            <p style="margin-bottom: 1rem; font-size: 0.9rem;">Scan this QR code:</p>
            <div id="qrcode" style="margin: 0 auto; width: 200px; height: 200px; background-color: white; padding: 10px; border-radius: 8px;"></div>
            <button id="downloadQrBtn" class="btn" style="background-color: var(--success-color); color: white; border-radius: 8px; padding: 0.5rem 1rem; margin-top: 0.75rem; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 0.5rem;" disabled>
                <i class="fas fa-download"></i> Download QR Code
            </button>
        </div>
        
        <!-- URL Section -->
        <p style="margin-bottom: 0.75rem; font-size: 0.9rem;">Or copy this link:</p>
        <div style="display: flex; margin-bottom: 1.5rem;">
            <input type="text" id="shareUrlInput" readonly style="flex: 1; padding: 0.75rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px 0 0 8px; font-size: 0.9rem;">
            <button id="copyShareUrlBtn" class="btn" style="background-color: var(--primary-color); color: white; border-radius: 0 8px 8px 0; padding: 0 1rem;">
                <i class="fas fa-copy"></i>
            </button>
        </div>
        <button id="closeShareModalBtn" class="btn btn-primary" style="width: 100%;">Close</button>
    </div>

    <!-- Modal Backdrop -->
    <div id="modalBackdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 150;"></div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-group">
            <h3>User Mode</h3>
            <select id="userModeSelect">
                <option value="customer">Customer (Foreign Language)</option>
                <option value="receiver">Receiver (Base Language)</option>
            </select>
        </div>
        <div class="settings-group">
            <h3>Auto-Detect Device</h3>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="autoDetectToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <label for="autoDetectToggle">
                    Auto-detect mode based on screen size
                </label>
            </div>
        </div>
        <div class="settings-group">
            <h3>Customer Name</h3>
            <input type="text" id="customerNameInput" placeholder="Enter custom customer name">
        </div>
        <div class="settings-group">
            <h3>Customer Language</h3>
            <select id="customerLanguageSelect">
                <option value="fr">French</option>
                <option value="es">Spanish</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="ja">Japanese</option>
                <option value="zh">Chinese</option>
                <option value="ru">Russian</option>
                <option value="pt">Portuguese</option>
                <option value="ar">Arabic</option>
                <option value="hi">Hindi</option>
                <option value="sr">Serbian</option>
                <option value="sq">Albanian</option>
                <option value="uk">Ukrainian</option>
                <!-- Add more languages as needed -->
            </select>
        </div>
        <div class="settings-group">
            <h3>Base Language</h3>
            <select id="baseLanguageSelect">
                <option value="de" selected>German</option>
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="es">Spanish</option>
                <option value="sr">Serbian</option>
                <option value="sq">Albanian</option>
                <option value="uk">Ukrainian</option>
                <!-- Add more languages as needed -->
            </select>
        </div>
        <div class="settings-group">
            <h3>Claude API Key</h3>
            <input type="password" id="apiKeyInput" placeholder="Enter your Claude API key">
        </div>
        <div class="settings-group">
            <h3>Claude API Model</h3>
            <select id="modelSelect">
                <option value="claude-3-haiku-20240307" selected>Claude 3 Haiku</option>
                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
                <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet</option>
                <option value="claude-4">Claude 4.0</option>
            </select>
        </div>
        <div class="settings-group">
            <h3>Summary Prompt</h3>
            <textarea id="summaryPromptInput" rows="4" style="resize: vertical; font-size: 0.85rem; width: 100%;" placeholder="Customize the summary prompt here...">Please analyze the customer's messages in this conversation and provide a concise summary of key information, requests, concerns, and any action items. Include important details like dates, quantities, or specific references. Format your response as a clear, bulleted list in the base language.</textarea>
        </div>
    </div>

    <script>
        // DOM elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const userModeSelect = document.getElementById('userModeSelect');
        const customerLanguageSelect = document.getElementById('customerLanguageSelect');
        const baseLanguageSelect = document.getElementById('baseLanguageSelect');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const modelSelect = document.getElementById('modelSelect');
        const typingIndicator = document.getElementById('typingIndicator');
        const summaryBtn = document.getElementById('summaryBtn');
        const summaryPromptInput = document.getElementById('summaryPromptInput');
        
        // Detect if user is on mobile (customer) or desktop (receiver)
        function detectDeviceType() {
            return window.innerWidth < 768 ? 'customer' : 'receiver';
        }

        // Token management functions
        function generateSessionToken() {
            // Use crypto API to generate a secure random token (UUID-like)
            const array = new Uint8Array(16);
            window.crypto.getRandomValues(array);
            
            // Format as UUID-like string
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }
        
        function getSessionToken() {
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('session');
            
            // If no token in URL, generate one and update URL
            if (!token) {
                token = generateSessionToken();
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('session', token);
                window.history.pushState({}, '', newUrl);
            }
            
            return token;
        }
        
        // Get or create session token
        const sessionToken = getSessionToken();
        console.log("Active session:", sessionToken.substring(0, 8) + '...');
        
        // Get URL parameters for settings
        const urlParams = new URLSearchParams(window.location.search);
        
        // Save API key from URL to localStorage if it exists
        if (urlParams.get('apiKey')) {
            localStorage.setItem('claudeApiKey', urlParams.get('apiKey'));
        }
        
        // App state
        const state = {
            userMode: detectDeviceType(), // Auto-detect initial mode
            customerLanguage: urlParams.get('customerLang') || 'fr',
            baseLanguage: urlParams.get('baseLang') || 'de',
            apiKey: urlParams.get('apiKey') || localStorage.getItem('claudeApiKey') || '',
            model: 'claude-3-haiku-20240307', // Use Claude 3 Haiku which is known to work with the API key
            messages: [],
            autoModeDetection: true, // Flag to enable/disable auto detection
            customerName: urlParams.get('customerName') || 'Customer', // Get from URL or use default
            summaryPrompt: 'Please analyze the customer\'s messages in this conversation and provide a concise summary of key information, requests, concerns, and any action items. Include important details like dates, quantities, or specific references. Format your response as a clear, bulleted list in the base language.',
            sessionToken: sessionToken,
            sessionUpdated: Date.now() // Timestamp for expiry tracking
        };

        // Function to create prefixed localStorage keys
        function getStorageKey(key) {
            return `session_${state.sessionToken}_${key}`;
        }
        
        // Check for session expiry (31 days = 2678400000 ms)
        function checkSessionExpiry() {
            // Go through all localStorage items to find sessions
            const SESSION_EXPIRY = 31 * 24 * 60 * 60 * 1000; // 31 days in milliseconds
            const now = Date.now();
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Look for session data
                if (key.startsWith('session_') && key.includes('_timestamp')) {
                    const sessionId = key.split('_')[1];
                    const timestamp = parseInt(localStorage.getItem(key));
                    
                    // Check if session is expired
                    if (now - timestamp > SESSION_EXPIRY) {
                        console.log(`Removing expired session: ${sessionId}`);
                        // Remove all data for this session
                        for (let j = localStorage.length - 1; j >= 0; j--) {
                            const itemKey = localStorage.key(j);
                            if (itemKey.includes(`session_${sessionId}_`)) {
                                localStorage.removeItem(itemKey);
                            }
                        }
                    }
                }
            }
        }
        
        // Run expiry check
        checkSessionExpiry();
        
        // Update timestamp for current session
        localStorage.setItem(getStorageKey('timestamp'), Date.now().toString());
        
        // Initialize from localStorage if available for this session
        const settingsKey = getStorageKey('settings');
        // Prioritize URL parameters over saved settings
        if (localStorage.getItem(settingsKey)) {
            const savedSettings = JSON.parse(localStorage.getItem(settingsKey));
            
            // Only use saved settings for values not provided in URL
            if (!urlParams.get('customerLang')) {
                state.customerLanguage = savedSettings.customerLanguage || state.customerLanguage;
            }
            
            if (!urlParams.get('baseLang')) {
                state.baseLanguage = savedSettings.baseLanguage || state.baseLanguage;
            }
            
            if (!urlParams.get('customerName')) {
                state.customerName = savedSettings.customerName || state.customerName;
            }
            
            state.userMode = savedSettings.userMode || state.userMode;
            state.model = savedSettings.model || state.model;
            state.autoModeDetection = savedSettings.autoModeDetection !== undefined 
                ? savedSettings.autoModeDetection 
                : state.autoModeDetection;
            state.summaryPrompt = savedSettings.summaryPrompt || state.summaryPrompt;
            
            // Update UI to reflect saved settings
            userModeSelect.value = state.userMode;
            customerLanguageSelect.value = state.customerLanguage;
            baseLanguageSelect.value = state.baseLanguage;
            modelSelect.value = state.model;
            
            if (document.getElementById('autoDetectToggle')) {
                document.getElementById('autoDetectToggle').checked = state.autoModeDetection;
            }
            
            if (document.getElementById('customerNameInput')) {
                document.getElementById('customerNameInput').value = state.customerName;
            }
            
            if (summaryPromptInput) {
                summaryPromptInput.value = state.summaryPrompt;
            }
        } else if (state.autoModeDetection) {
            // If no saved settings but auto-detection is on, set mode based on screen size
            state.userMode = detectDeviceType();
            userModeSelect.value = state.userMode;
        }
        
        // Make sure buttons are initially visible or hidden based on mode
        if (summaryBtn) {
            summaryBtn.style.display = state.userMode === 'customer' ? 'none' : 'flex';
        }
        if (settingsBtn) {
            settingsBtn.style.display = state.userMode === 'customer' ? 'none' : 'flex';
        }
        
        // Share button should only be visible in receiver mode
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn) {
            shareBtn.style.display = state.userMode === 'customer' ? 'none' : 'flex';
        }
        
        // Info button should only be visible in receiver mode
        const infoBtn = document.getElementById('infoBtn');
        if (infoBtn) {
            infoBtn.style.display = state.userMode === 'customer' ? 'none' : 'flex';
        }

        // Set interface based on current mode
        updateInterfaceMode();

        // Function to update the interface based on current mode
        function updateInterfaceMode() {
            document.body.className = state.userMode === 'customer' ? 'customer-mode' : 'receiver-mode';
            
            // Update the mode indicator to show customer name if in customer mode
            const modeIndicator = document.getElementById('modeIndicator');
            const logoImage = document.getElementById('logoImage');
            
            if (modeIndicator) {
                if (state.userMode === 'customer') {
                    modeIndicator.innerHTML = `<i class="fas fa-user-circle"></i> ${state.customerName}`;
                    modeIndicator.className = 'mode-indicator customer-badge';
                    // Hide buttons in customer mode
                    if (typeof summaryBtn !== 'undefined' && summaryBtn) {
                        summaryBtn.style.display = 'none';
                    }
                    if (settingsBtn) {
                        settingsBtn.style.display = 'none';
                    }
                    if (shareBtn) {
                        shareBtn.style.display = 'none';
                    }
                    // Also hide info button in customer mode
                    const infoBtn = document.getElementById('infoBtn');
                    if (infoBtn) {
                        infoBtn.style.display = 'none';
                    }
                    // Make logo smaller in customer mode
                    if (logoImage) {
                        logoImage.style.height = '3rem';
                    }
                } else {
                    modeIndicator.innerHTML = `<i class="fas fa-headset"></i> GGG Schreibdienst`;
                    modeIndicator.className = 'mode-indicator';
                    // Show buttons in receiver mode
                    if (typeof summaryBtn !== 'undefined' && summaryBtn) {
                        summaryBtn.style.display = 'flex';
                    }
                    if (settingsBtn) {
                        settingsBtn.style.display = 'flex';
                    }
                    if (shareBtn) {
                        shareBtn.style.display = 'flex';
                    }
                    // Show info button in receiver mode
                    const infoBtn = document.getElementById('infoBtn');
                    if (infoBtn) {
                        infoBtn.style.display = 'flex';
                    }
                    // Reset logo size in receiver mode
                    if (logoImage) {
                        logoImage.style.height = '4.5rem';
                    }
                }
            }
        }

        // Populate API key from localStorage if available
        if (state.apiKey) {
            apiKeyInput.value = state.apiKey;
        }

        // Load chat history from localStorage if available for this session
        const chatHistoryKey = getStorageKey('chatHistory');
        if (localStorage.getItem(chatHistoryKey)) {
            state.messages = JSON.parse(localStorage.getItem(chatHistoryKey));
            renderMessages();
        }
        
        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Get the settings icon element
        const settingsIcon = settingsBtn.querySelector('i.fas.fa-cog');
        
        // Add click handler to both the button and the icon
        function toggleSettingsPanel() {
            settingsPanel.classList.toggle('active');
            
            // Hide info panel if it's open
            if (document.getElementById('infoPanel').style.display === 'block') {
                document.getElementById('infoPanel').style.display = 'none';
            }
        }
        
        settingsBtn.addEventListener('click', toggleSettingsPanel);
        // Add a separate event listener for the icon to ensure clicks on it work
        settingsIcon.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent multiple triggers
            toggleSettingsPanel();
        });
        
        // Info button event listener
        document.getElementById('infoBtn').addEventListener('click', () => {
            const infoPanel = document.getElementById('infoPanel');
            infoPanel.style.display = infoPanel.style.display === 'block' ? 'none' : 'block';
            
            // Hide settings panel if it's open
            settingsPanel.classList.remove('active');
        });
        
        // Close info button event listener
        document.getElementById('closeInfoBtn').addEventListener('click', () => {
            document.getElementById('infoPanel').style.display = 'none';
        });
        
        // Share button and modal functionality
        const shareModal = document.getElementById('shareModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const shareUrlInput = document.getElementById('shareUrlInput');
        
        // Open share modal
        shareBtn.addEventListener('click', () => {
            // Get the base URL with the session token
            const url = new URL(window.location.href);
            
            // Add essential settings as parameters to the URL
            // Add API key (if exists)
            if (state.apiKey) {
                url.searchParams.set('apiKey', state.apiKey);
            }
            
            // Add customer name
            url.searchParams.set('customerName', state.customerName);
            
            // Add customer language
            url.searchParams.set('customerLang', state.customerLanguage);
            
            // Add base language
            url.searchParams.set('baseLang', state.baseLanguage);
            
            // Generate the complete share URL
            const shareUrl = url.toString();
            shareUrlInput.value = shareUrl;
            
            // Show modal and backdrop
            shareModal.style.display = 'block';
            modalBackdrop.style.display = 'block';
            
            // Generate QR code
            const qrcodeContainer = document.getElementById('qrcode');
            // Clear any existing QR code
            qrcodeContainer.innerHTML = '';
            
            try {
                // Generate new QR code using image
                QRCode.toDataURL(shareUrl, {
                    width: 180,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                }, (error, url) => {
                    if (error) {
                        console.error('Error generating QR code:', error);
                        // Show error in QR code container
                        qrcodeContainer.innerHTML = `<p style="color: var(--error-color); padding: 20px;">Could not generate QR code</p>`;
                    } else {
                        // Create an image element with the QR code
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = 'QR Code for sharing conversation';
                        img.style.width = '100%';
                        img.style.height = 'auto';
                        img.style.maxWidth = '180px';
                        img.style.display = 'block';
                        img.style.margin = '0 auto';
                        
                        // Add the image to the container
                        qrcodeContainer.appendChild(img);
                        
                        // Enable download button
                        const downloadQrBtn = document.getElementById('downloadQrBtn');
                        downloadQrBtn.disabled = false;
                        
                        // Store the dataURL for downloading
                        downloadQrBtn.setAttribute('data-qr-url', url);
                    }
                });
            } catch (e) {
                console.error('QR code generation failed:', e);
                qrcodeContainer.innerHTML = `<p style="color: var(--error-color); padding: 20px;">Could not generate QR code</p>`;
                
                // Disable download button
                const downloadQrBtn = document.getElementById('downloadQrBtn');
                downloadQrBtn.disabled = true;
            }
        });
        
        // Copy URL button functionality
        document.getElementById('copyShareUrlBtn').addEventListener('click', () => {
            // Use modern clipboard API if available, fallback to older method
            const copyBtn = document.getElementById('copyShareUrlBtn');
            const originalIcon = copyBtn.innerHTML;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareUrlInput.value)
                    .then(() => {
                        showToast('URL copied to clipboard', 'success');
                        // Visual feedback
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalIcon;
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        // Fallback to old method
                        shareUrlInput.select();
                        document.execCommand('copy');
                        showToast('URL copied to clipboard', 'success');
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalIcon;
                        }, 1500);
                    });
            } else {
                // Fallback for older browsers
                shareUrlInput.select();
                document.execCommand('copy');
                showToast('URL copied to clipboard', 'success');
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = originalIcon;
                }, 1500);
            }
        });
        
        // Close share modal
        document.getElementById('closeShareModalBtn').addEventListener('click', () => {
            shareModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
        });
        
        // Close modal when clicking on backdrop
        modalBackdrop.addEventListener('click', () => {
            shareModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
        });
        
        // QR Code download button functionality
        document.getElementById('downloadQrBtn').addEventListener('click', () => {
            const downloadQrBtn = document.getElementById('downloadQrBtn');
            const qrUrl = downloadQrBtn.getAttribute('data-qr-url');
            
            if (qrUrl) {
                // Create a temporary link element
                const downloadLink = document.createElement('a');
                downloadLink.href = qrUrl;
                downloadLink.download = 'translator-qr-code.png';
                
                // Trigger download
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // Show toast
                showToast('QR Code downloaded', 'success');
            } else {
                showToast('QR Code not available', 'error');
            }
        });

        // Click outside panels to close them
        document.addEventListener('click', (e) => {
            // Close settings panel if clicked outside
            if (!settingsPanel.contains(e.target) && e.target !== settingsBtn && !e.target.closest('.fa-cog')) {
                settingsPanel.classList.remove('active');
            }
            
            // Close info panel if clicked outside
            const infoPanel = document.getElementById('infoPanel');
            const infoBtn = document.getElementById('infoBtn');
            if (infoPanel.style.display === 'block' && !infoPanel.contains(e.target) && e.target !== infoBtn && !e.target.closest('.fa-info-circle')) {
                infoPanel.style.display = 'none';
            }
        });

        // Settings change handlers
        userModeSelect.addEventListener('change', (e) => {
            state.userMode = e.target.value;
            updateInterfaceMode();
            saveSettings();
        });

        // Add event listener for auto detection toggle
        if (document.getElementById('autoDetectToggle')) {
            document.getElementById('autoDetectToggle').addEventListener('change', (e) => {
                state.autoModeDetection = e.target.checked;
                if (state.autoModeDetection) {
                    // If turning auto detection on, immediately apply it
                    state.userMode = detectDeviceType();
                    userModeSelect.value = state.userMode;
                    updateInterfaceMode();
                }
                saveSettings();
            });
        }

        // Add resize listener to handle device orientation changes
        window.addEventListener('resize', () => {
            if (state.autoModeDetection) {
                const newMode = detectDeviceType();
                if (newMode !== state.userMode) {
                    state.userMode = newMode;
                    userModeSelect.value = state.userMode;
                    updateInterfaceMode();
                    // Add a system message about the mode change
                    addSystemMessage(`Device type detected as ${newMode === 'customer' ? 'mobile' : 'desktop'}. Switched to ${newMode === 'customer' ? 'Customer' : 'Receiver'} mode.`);
                    // Show toast notification
                    showToast(`Switched to ${newMode === 'customer' ? 'Customer' : 'Receiver'} mode`, 'info');
                }
            }
        });

        customerLanguageSelect.addEventListener('change', (e) => {
            state.customerLanguage = e.target.value;
            saveSettings();
        });

        baseLanguageSelect.addEventListener('change', (e) => {
            state.baseLanguage = e.target.value;
            saveSettings();
        });

        apiKeyInput.addEventListener('change', (e) => {
            state.apiKey = e.target.value;
            localStorage.setItem('claudeApiKey', state.apiKey);
            saveSettings();
            
            if (state.apiKey) {
                showToast('API key saved', 'success');
            } else {
                showToast('API key removed', 'warning');
            }
        });
        
        // Add model selection listener
        modelSelect.addEventListener('change', (e) => {
            state.model = e.target.value;
            saveSettings();
            showToast(`Model changed to ${e.target.options[e.target.selectedIndex].text}`, 'info');
        });
        
        // Add summary prompt input listener
        if (summaryPromptInput) {
            summaryPromptInput.addEventListener('change', (e) => {
                state.summaryPrompt = e.target.value;
                saveSettings();
                showToast('Summary prompt updated', 'success');
            });
        }
        
        // Add summary button listener
        if (summaryBtn) {
            summaryBtn.addEventListener('click', generateConversationSummary);
        }

        // Customer name input listener
        if (document.getElementById('customerNameInput')) {
            document.getElementById('customerNameInput').addEventListener('change', (e) => {
                state.customerName = e.target.value || 'Customer';
                saveSettings();
                // Update mode indicator if we're in customer mode
                if (state.userMode === 'customer') {
                    const modeIndicator = document.getElementById('modeIndicator');
                    if (modeIndicator) {
                        modeIndicator.innerHTML = `<i class="fas fa-user-circle"></i> ${state.customerName}`;
                    }
                }
                // Update any existing customer messages in the UI
                renderMessages();
            });
        }
        
        // Voice input button listener
        const voiceBtn = document.getElementById('voiceBtn');
        if (voiceBtn) {
            voiceBtn.addEventListener('click', startVoiceInput);
        }
        
        // Voice input functionality
        function startVoiceInput() {
            // No HTTPS requirement for local testing
            // Note: In a production environment, HTTPS would be required for microphone access
            
            // Check if running on Android
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            // Show helper toast for Android devices the first time
            if (isAndroid) {
                // Use localStorage to check if this is first time (per session)
                const hasMicHint = sessionStorage.getItem('microphoneHintShown');
                if (!hasMicHint) {
                    showToast("Please allow microphone access when prompted", "info", 4000);
                    sessionStorage.setItem('microphoneHintShown', 'true');
                }
            }
            
            // Check if speech recognition is supported
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                addSystemMessage("Voice input is not supported in your browser. Please use Chrome, Edge, or Safari.");
                showToast("Voice input not supported in this browser", "error");
                return;
            }
            
            try {
                // Create speech recognition object
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                // Get appropriate language code based on user mode
                let langCode = 'en-US'; // Default fallback
                
                if (state.userMode === 'customer') {
                    // Map language codes to BCP 47 language tags for speech recognition
                    const langMap = {
                        'en': 'en-US',
                        'fr': 'fr-FR',
                        'es': 'es-ES',
                        'de': 'de-DE',
                        'it': 'it-IT',
                        'ja': 'ja-JP',
                        'zh': 'zh-CN',
                        'ru': 'ru-RU',
                        'pt': 'pt-BR',
                        'ar': 'ar-SA',
                        'hi': 'hi-IN',
                        'sr': 'sr-RS',
                        'sq': 'sq-AL',
                        'uk': 'uk-UA'
                    };
                    langCode = langMap[state.customerLanguage] || 'en-US';
                } else {
                    // Map for base language
                    const langMap = {
                        'en': 'en-US',
                        'fr': 'fr-FR',
                        'es': 'es-ES',
                        'de': 'de-DE',
                        'sr': 'sr-RS',
                        'sq': 'sq-AL',
                        'uk': 'uk-UA'
                    };
                    langCode = langMap[state.baseLanguage] || 'en-US';
                }
                
                // Configure speech recognition
                recognition.lang = langCode;
                recognition.continuous = true; // Enable continuous recognition
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;
                // Increase timeout duration
                const speechTimeout = 12000; // 12 seconds
                
                // Show recording indicator
                voiceBtn.style.backgroundColor = 'var(--error-color)';
                voiceBtn.innerHTML = '<i class="fas fa-circle" style="animation: pulse 1.5s infinite"></i>';
                showToast(`Listening in ${getLanguageName(state.userMode === 'customer' ? state.customerLanguage : state.baseLanguage)}...`, "info");
                
                // Temporary variable to store interim results
                let interimTranscript = '';
                
                // Create a flag to track speech recognition state
                let isRecognitionActive = true;
                
                // Start recording with timeout
                try {
                    recognition.start();
                    console.log('Speech recognition started successfully');
                } catch (startError) {
                    console.error('Error starting speech recognition:', startError);
                    showToast("Could not start speech recognition. Please try again.", "error");
                    isRecognitionActive = false;
                    
                    // Reset button state
                    voiceBtn.style.backgroundColor = 'var(--success-color)';
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    return;
                }
                
                // Set a timeout to prevent silent errors
                const speechTimeoutHandler = setTimeout(() => {
                    if (isRecognitionActive) {
                        try {
                            recognition.stop();
                            isRecognitionActive = false;
                        } catch (stopError) {
                            console.error('Error stopping speech recognition:', stopError);
                        }
                        showToast("Voice input timed out. Please try again and speak clearly.", "warning");
                        // Reset button state
                        voiceBtn.style.backgroundColor = 'var(--success-color)';
                        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    }
                }, speechTimeout);
                
                // Handle interim results
                recognition.onresult = function(event) {
                    console.log('Speech recognition result received');
                    interimTranscript = '';
                    let finalTranscript = '';
                    
                    // Get transcript from all results
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Update input field with results
                    if (finalTranscript !== '') {
                        messageInput.value = finalTranscript;
                    } else {
                        messageInput.value = interimTranscript;
                    }
                    
                    // Reset the timeout since we're getting results
                    clearTimeout(speechTimeoutHandler);
                    speechTimeoutHandler = setTimeout(() => {
                        if (isRecognitionActive) {
                            try {
                                recognition.stop();
                                isRecognitionActive = false;
                            } catch (stopError) {
                                console.error('Error stopping speech recognition:', stopError);
                            }
                        }
                    }, speechTimeout);
                };
                
                // Handle errors
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    
                    // Check if running on Android
                    const isAndroid = /Android/i.test(navigator.userAgent);
                    
                    // Handle different error types
                    switch(event.error) {
                        case 'no-speech':
                            showToast("No speech detected, please try again", "warning");
                            break;
                        case 'aborted':
                            // Aborted errors can happen during normal operation, so we don't show an error
                            console.log('Speech recognition aborted');
                            break;
                        case 'audio-capture':
                            showToast("No microphone detected. Please check your device settings.", "error");
                            break;
                        case 'network':
                            showToast("Network error occurred. Please check your connection.", "error");
                            break;
                        case 'not-allowed':
                            if (isAndroid) {
                                // More specific guidance for Android users
                                showToast("Please allow microphone access in your Chrome settings", "error", 5000);
                                addSystemMessage("To enable microphone on Android:\n1. Tap the address bar\n2. Tap the info/lock icon\n3. Tap Site Settings\n4. Set Microphone to Allow");
                            } else {
                                showToast("Microphone access denied. Please allow microphone access in your browser.", "error");
                            }
                            break;
                        default:
                            showToast(`Voice input error: ${event.error}`, "error");
                    }
                    
                    // Reset button state
                    voiceBtn.style.backgroundColor = 'var(--success-color)';
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                };
                
                // Handle end of speech
                recognition.onend = function() {
                    console.log('Speech recognition ended');
                    // Clear the timeout when speech recognition ends
                    clearTimeout(speechTimeoutHandler);
                    isRecognitionActive = false;
                    
                    // Reset button state
                    voiceBtn.style.backgroundColor = 'var(--success-color)';
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    
                    if (messageInput.value.trim() !== '') {
                        showToast("Voice input captured", "success");
                    }
                };
                
                // Add safety cleanup to ensure recognition is stopped
                window.addEventListener('beforeunload', function() {
                    if (isRecognitionActive) {
                        try {
                            recognition.stop();
                        } catch (e) {
                            console.log('Error stopping recognition on page unload');
                        }
                    }
                });
            } catch (error) {
                console.error('Error initializing speech recognition:', error);
                showToast("Failed to initialize voice input", "error");
                
                // Reset button state
                voiceBtn.style.backgroundColor = 'var(--success-color)';
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                return null;
            }
            
            // Return the recognition object for external control
            return recognition;
        }

        // Functions
        function saveSettings() {
            const settingsKey = getStorageKey('settings');
            localStorage.setItem(settingsKey, JSON.stringify({
                userMode: state.userMode,
                customerLanguage: state.customerLanguage,
                baseLanguage: state.baseLanguage,
                model: state.model,
                autoModeDetection: state.autoModeDetection,
                customerName: state.customerName,
                summaryPrompt: state.summaryPrompt
            }));
            
            // Update session timestamp
            localStorage.setItem(getStorageKey('timestamp'), Date.now().toString());
        }

        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;

            // Clear input
            messageInput.value = '';

            // Show typing indicator
            typingIndicator.classList.add('active');

            // Determine sender based on current mode
            const sender = state.userMode === 'customer' ? 'customer' : 'receiver';
            
            // Add message to state and UI
            const message = {
                id: Date.now().toString(),
                sender,
                content,
                timestamp: new Date().toISOString()
            };
            
            state.messages.push(message);
            renderMessages();
            
            // Save to localStorage with session token
            localStorage.setItem(getStorageKey('chatHistory'), JSON.stringify(state.messages));

            // If API key is set, process through Claude
            if (state.apiKey) {
                processThroughClaude(message);
            } else {
                // If no API key, hide typing indicator
                typingIndicator.classList.remove('active');
                // Show message to set API key
                addSystemMessage("Please set your Claude API key in the settings.");
            }
        }

        async function processThroughClaude(message) {
            try {
                // Determine what we're asking Claude to do based on the sender
                let prompt;
                const sourceLang = message.sender === 'customer' ? state.customerLanguage : state.baseLanguage;
                const targetLang = message.sender === 'customer' ? state.baseLanguage : state.customerLanguage;
                
                if (message.sender === 'customer') {
                    // Customer to Receiver (translate foreign language to base language)
                    prompt = `I'm a customer speaking ${getLanguageName(sourceLang)}. Please translate the following message accurately to ${getLanguageName(targetLang)}, keeping the tone and intent. Only respond with the pure translation, nothing else: "${message.content}"`;
                } else {
                    // Receiver to Customer (translate base language to foreign language)
                    prompt = `I'm a service provider speaking ${getLanguageName(sourceLang)}. Please translate the following message accurately to ${getLanguageName(targetLang)}, keeping the tone and intent. Only respond with the pure translation, nothing else: "${message.content}"`;
                }

                const response = await callClaudeAPI(prompt);
                
                // Hide typing indicator
                typingIndicator.classList.remove('active');

                if (response) {
                    // Add Claude's response to the chat
                    const claudeMessage = {
                        id: Date.now().toString(),
                        sender: 'claude',
                        content: response,
                        timestamp: new Date().toISOString()
                    };
                    
                    state.messages.push(claudeMessage);
                    renderMessages();
                    
                    // Save to localStorage with session token
                    localStorage.setItem(getStorageKey('chatHistory'), JSON.stringify(state.messages));
                }
            } catch (error) {
                console.error('Error processing through Claude:', error);
                typingIndicator.classList.remove('active');
                addSystemMessage(`Error: ${error.message}`);
            }
        }

        async function callClaudeAPI(prompt) {
            try {
                console.log("Calling Claude API...");
                
                // Use the API file in the same directory as the HTML file
                const apiUrl = new URL('api.php', window.location.href.split('?')[0]).toString();
                console.log("Using API endpoint:", apiUrl);
                
                console.log("API URL:", apiUrl);
                console.log("API Key:", state.apiKey ? "Provided" : "Missing");
                
                // Log the data being sent (excluding the full API key)
                const requestData = {
                    apiKey: state.apiKey ? `${state.apiKey.substring(0, 5)}...${state.apiKey.substring(state.apiKey.length - 4)}` : null,
                    model: state.model,
                    promptLength: prompt?.length || 0
                };
                console.log("Request data:", requestData);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: state.apiKey,
                        model: state.model,
                        prompt: prompt
                    }),
                    // Add credentials
                    credentials: 'same-origin'
                });
                
                // Log response details
                console.log("Response status:", response.status);
                console.log("Response headers:", {
                    'content-type': response.headers.get('content-type'),
                    'server': response.headers.get('server')
                });

                if (!response.ok) {
                    // Check content type to determine how to handle the error
                    const contentType = response.headers.get('content-type');
                    
                    if (contentType && contentType.includes('application/json')) {
                        // Parse JSON error
                        const errorData = await response.json();
                        console.error("API JSON error response:", errorData);
                        throw new Error(`API error: ${errorData.error || response.statusText}`);
                    } else {
                        // Get text error
                        const errorText = await response.text();
                        console.error("API non-JSON error response:", errorText);
                        throw new Error(`API error (${response.status}): ${response.statusText} - ${errorText.substring(0, 100)}`);
                    }
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error("Non-JSON response received:", text.substring(0, 200) + "...");
                    throw new Error("Received non-JSON response from API");
                }

                const data = await response.json();
                console.log("Claude API response received:", data);
                
                // Check if the response has the expected structure
                if (data && data.content && data.content[0] && data.content[0].text) {
                    return data.content[0].text;
                } else {
                    console.error("Unexpected API response structure:", data);
                    throw new Error("Unexpected API response format");
                }
            } catch (error) {
                console.error('Claude API call failed:', error);
                
                // Fall back to simulation mode if API fails
                console.log("Falling back to simulation mode");
                return simulateTranslation(prompt);
            }
        }
        
        // Function to simulate translation for prototype demonstration
        function simulateTranslation(prompt) {
            // Extract the original message from the prompt
            const messageMatch = prompt.match(/"(.*?)"/);
            let originalMessage = messageMatch ? messageMatch[1] : "No message found";
            
            // Determine if we're translating from customer to receiver or vice versa
            const isCustomerToReceiver = prompt.includes(`I'm a customer speaking`);
            
            if (isCustomerToReceiver) {
                // Simulate translation with error message
                return `[API ERROR - FALLBACK TRANSLATION]\n\nTranslated message:\n${originalMessage}\n\n---\n\nThis is a fallback translation because an error occurred when calling the Claude API. Please check your API key and internet connection, then try again.`;
            } else {
                // Simulate translation from receiver to customer
                return `[API ERROR - FALLBACK TRANSLATION]\n\nTranslated message:\n${originalMessage}\n\n---\n\nThis is a fallback translation because an error occurred when calling the Claude API. Please check your API key and internet connection, then try again.`;
            }
        }

        function renderMessages() {
            // Clear chat container
            chatContainer.innerHTML = '';
            
            // Add each message
            state.messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                
                // Add appropriate class based on sender
                switch (message.sender) {
                    case 'customer':
                        messageElement.classList.add('customer-message');
                        break;
                    case 'claude':
                        messageElement.classList.add('claude-message');
                        break;
                    case 'receiver':
                        messageElement.classList.add('receiver-message');
                        break;
                    case 'system':
                        messageElement.classList.add('claude-message');
                        break;
                    case 'summary':
                        messageElement.classList.add('summary-message');
                        break;
                }
                
                // Add sender name
                const senderElement = document.createElement('div');
                senderElement.classList.add('sender');
                senderElement.textContent = getSenderDisplayName(message.sender);
                messageElement.appendChild(senderElement);
                
                // Add content
                const contentElement = document.createElement('div');
                contentElement.classList.add('content');
                contentElement.textContent = message.content;
                messageElement.appendChild(contentElement);
                
                // Add copy button for summary messages
                if (message.sender === 'summary') {
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.title = 'Copy summary to clipboard';
                    copyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        navigator.clipboard.writeText(message.content)
                            .then(() => {
                                showToast('Summary copied to clipboard', 'success');
                                // Change icon temporarily to show success
                                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                                setTimeout(() => {
                                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                                }, 1500);
                            })
                            .catch(err => {
                                console.error('Error copying text: ', err);
                                showToast('Failed to copy to clipboard', 'error');
                            });
                    });
                    messageElement.appendChild(copyBtn);
                }
                
                // Add to chat container
                chatContainer.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function getSenderDisplayName(sender) {
            switch (sender) {
                case 'customer':
                    return `${state.customerName} (${getLanguageName(state.customerLanguage)})`;
                case 'claude':
                    return 'Translator';
                case 'receiver':
                    return `GGG Schreibdienst (${getLanguageName(state.baseLanguage)})`;
                case 'system':
                    return 'System';
                case 'summary':
                    return 'Conversation Summary';
                default:
                    return sender;
            }
        }

        function getLanguageName(langCode) {
            const languages = {
                'en': 'English',
                'fr': 'French',
                'es': 'Spanish',
                'de': 'German',
                'it': 'Italian',
                'ja': 'Japanese',
                'zh': 'Chinese',
                'ru': 'Russian',
                'pt': 'Portuguese',
                'ar': 'Arabic',
                'hi': 'Hindi',
                'sr': 'Serbian',
                'sq': 'Albanian',
                'uk': 'Ukrainian'
            };
            return languages[langCode] || langCode;
        }

        function addSystemMessage(text) {
            const systemMessage = {
                id: Date.now().toString(),
                sender: 'system',
                content: text,
                timestamp: new Date().toISOString()
            };
            
            state.messages.push(systemMessage);
            renderMessages();
            
            // Save to localStorage with session token
            localStorage.setItem(getStorageKey('chatHistory'), JSON.stringify(state.messages));
            
            // Add toast notification for important system messages
            showToast(text, 'info');
        }
        
        // Toast notification function
        function showToast(message, type = 'info', duration = 4000) {
            // Create toast container if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container';
                document.body.appendChild(toastContainer);
                
                // Add toast container styles
                const style = document.createElement('style');
                style.textContent = `
                    .toast-container {
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        z-index: 9999;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                        max-width: 300px;
                    }
                    .toast {
                        padding: 12px 16px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        animation: slideIn 0.3s ease, fadeOut 0.5s ease 3.5s forwards;
                        cursor: pointer;
                        font-size: 0.9rem;
                        color: var(--text-primary);
                        max-width: 100%;
                    }
                    .toast-info {
                        background-color: var(--primary-color);
                        border-left: 4px solid var(--primary-dark);
                    }
                    .toast-success {
                        background-color: var(--success-color);
                        border-left: 4px solid #065f46;
                    }
                    .toast-warning {
                        background-color: var(--warning-color);
                        border-left: 4px solid #92400e;
                    }
                    .toast-error {
                        background-color: var(--error-color);
                        border-left: 4px solid #991b1b;
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Add icon based on type
            let icon = '';
            switch (type) {
                case 'info': icon = '<i class="fas fa-info-circle" style="color: white;"></i>'; break;
                case 'success': icon = '<i class="fas fa-check-circle" style="color: white;"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-triangle" style="color: white;"></i>'; break;
                case 'error': icon = '<i class="fas fa-times-circle" style="color: white;"></i>'; break;
            }
            toast.innerHTML = `${icon}<span style="color: white;">${message}</span>`;
            
            // Add click handler to dismiss
            toast.addEventListener('click', () => {
                toast.remove();
            });
            
            // Add to container and auto-remove after animation
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, duration);
        }

        // Function to generate conversation summary
        async function generateConversationSummary() {
            // Check if there are any customer messages
            const customerMessages = state.messages.filter(msg => msg.sender === 'customer');
            if (customerMessages.length === 0) {
                showToast('No customer messages to summarize', 'warning');
                return;
            }
            
            // Check if API key is set
            if (!state.apiKey) {
                showToast('API key is required for summaries', 'error');
                addSystemMessage("Please set your Claude API key in the settings to use the summary feature.");
                return;
            }
            
            // Show typing indicator
            typingIndicator.classList.add('active');
            
            try {
                // Build conversation history formatted string
                const conversationHistory = customerMessages.map(msg => {
                    const timestamp = new Date(msg.timestamp).toLocaleTimeString();
                    return `[${timestamp}] ${state.customerName}: ${msg.content}`;
                }).join('\n\n');
                
                // Create prompt for Claude with explicit instruction to use base language
                const prompt = `${state.summaryPrompt}\n\nVery important: Your response MUST be in ${getLanguageName(state.baseLanguage)} language only.\n\nHere are the customer messages:\n\n${conversationHistory}`;
                
                // Call Claude API with the summary prompt
                const response = await callClaudeAPI(prompt);
                
                // Hide typing indicator
                typingIndicator.classList.remove('active');
                
                if (response) {
                    // Add summary to the chat
                    const summaryMessage = {
                        id: Date.now().toString(),
                        sender: 'summary',
                        content: response,
                        timestamp: new Date().toISOString()
                    };
                    
                    state.messages.push(summaryMessage);
                    renderMessages();
                    
                    // Save to localStorage with session token
                    localStorage.setItem(getStorageKey('chatHistory'), JSON.stringify(state.messages));
                    
                    // Show success notification
                    showToast('Summary generated', 'success');
                }
            } catch (error) {
                console.error('Error generating summary:', error);
                typingIndicator.classList.remove('active');
                addSystemMessage(`Error generating summary: ${error.message}`);
            }
        }
        
        // Add device info to welcome message
        if (state.messages.length === 0) {
            const deviceType = detectDeviceType();
            addSystemMessage(`Welcome to the Translator. Your device has been detected as ${deviceType === 'customer' ? 'MOBILE (Customer Mode)' : 'DESKTOP (Receiver Mode)'}. You can change this in settings if needed.`);
            
            // Add API key instructions
            addSystemMessage(`To use this application, please enter your Claude API key in the settings panel (). Click the  icon for more information about how this application works.`);
            
            // First test with direct API endpoint
            const basePath = window.location.pathname.includes('/public/') 
                ? window.location.pathname.substring(0, window.location.pathname.indexOf('/public/') + 8) 
                : window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
            
            const directApiUrl = window.location.origin + basePath + 'direct_api.php';
            console.log("Testing direct API connectivity at:", directApiUrl);
            
            fetch(directApiUrl)
                .then(res => {
                    console.log('Direct API response status:', res.status);
                    if (!res.ok) {
                        throw new Error(`Direct API error: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Direct API test successful:', data);
                    addSystemMessage(`Direct API connection established: ${data.message}`);
                    
                    // Now test the regular API endpoint through .htaccess
                    testApiWithHtaccess();
                })
                .catch(err => {
                    console.error('Direct API test failed:', err);
                    addSystemMessage(`Warning: Direct API test failed. Error: ${err.message}`);
                    
                    // Try the regular API endpoint anyway
                    testApiWithHtaccess();
                });
                
            function testApiWithHtaccess() {
                // Get direct URL to test.php
                const basePath = window.location.pathname.includes('/public/') 
                    ? window.location.pathname.substring(0, window.location.pathname.indexOf('/public/') + 8) 
                    : window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
                
                const testUrl = window.location.origin + basePath + 'api/test.php';
                console.log("Testing server connectivity at:", testUrl);
                
                fetch(testUrl)
                    .then(res => {
                        console.log('Server response status:', res.status);
                        console.log('Server response headers:', {
                            'content-type': res.headers.get('content-type'),
                            'server': res.headers.get('server')
                        });
                        
                        if (!res.ok) {
                            throw new Error(`Server returned ${res.status}: ${res.statusText}`);
                        }
                        
                        if (!res.headers.get('content-type')?.includes('application/json')) {
                            // If the response is not JSON, get the text and log it
                            return res.text().then(text => {
                                console.error('Non-JSON response received:', text);
                                throw new Error('Server returned non-JSON response');
                            });
                        }
                        
                        return res.json();
                    })
                    .then(data => {
                        console.log('Server connectivity test result:', data);
                        addSystemMessage(`Server connection established. Server status: ${data.status}`);
                        showToast('Server connected successfully', 'success');
                        
                        // Reset direct API flag if it was set
                        window.useDirectApi = false;
                    })
                    .catch(err => {
                        console.error('Server connectivity test failed:', err);
                        addSystemMessage(`Warning: Could not connect to server via .htaccess routing. API functionality may be limited. Error: ${err.message}`);
                        showToast('Server connection failed', 'error');
                        
                        // Try direct API for Claude as a fallback
                        addSystemMessage("Will use direct API access as fallback for Claude API calls.");
                        
                        // Update to use direct PHP instead of .htaccess routing
                        window.useDirectApi = true;
                    });
            }
        }
        
        // Function removed - no longer needed
        function checkForHttpsRecommendation() {
            // Not used in HTTP-only version
            return;
        }
        
        // Loading animation for the page
        document.addEventListener('DOMContentLoaded', () => {
            // HTTP-only version, no HTTPS checks needed
            
            // Add loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="loading-spinner">
                    <i class="fas fa-globe fa-spin"></i>
                    <span>Loading Translator...</span>
                </div>
            `;
            document.body.appendChild(loadingOverlay);
            
            // Add loading styles
            const style = document.createElement('style');
            style.textContent = `
                .loading-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: var(--background-color);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    opacity: 1;
                    transition: opacity 0.5s ease;
                }
                .loading-spinner {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 20px;
                    color: var(--primary-color);
                }
                .loading-spinner i {
                    font-size: 4rem;
                }
                .loading-spinner span {
                    font-size: 1.2rem;
                    font-weight: 500;
                    color: var(--text-primary);
                }
            `;
            document.head.appendChild(style);
            
            // Remove loading overlay after a delay
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.remove();
                    
                    // No HTTPS checks needed
                }, 500);
            }, 1000);
        });
    </script>
</body>
</html>